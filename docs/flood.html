<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>HCMC · Flood Risk Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>

  <!-- Scrollama -->
  <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
  <script src="https://unpkg.com/scrollama"></script>

  <!-- D3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

  <style>
    :root {
      --bg: #0a0a0a;
      --ink: #f5f5f5;
      --muted: #a1a1aa;
      --line: #27272a;
      --soft: #18181b;
      --accent: #f97316;
      --max: 1400px;
      --navH: 56px;
      --cardR: 4px;
      --shadow: 0 20px 60px rgba(0,0,0,.6);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", -apple-system, system-ui, sans-serif;
      color: var(--ink);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      padding-top: var(--navH); /* ✅ fixed nav offset */
    }

    a { color: inherit; text-decoration: none; }

    /* =========================
       ✅ Unified Top Nav (same as dashboard/index)
    ========================== */
    .topnav{
      position:fixed;
      top:0;
      width:100%;
      z-index:9999;
      background:rgba(10,10,10,.98);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--line);
      height: var(--navH);
      display:flex;
      align-items:center;
    }
    .nav-inner{
      width: 100%;
      max-width:var(--max);
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      font-weight:900;
      font-size:15px;
      letter-spacing:-.3px;
      color:#ffffff;
    }
    .nav-links{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:13.5px;
      font-weight:600;
    }
    .nav-links a{
      padding:8px 14px;
      border-radius:8px;
      transition:all .15s;
      color:#e5e5e7;
    }
    .nav-links a:hover{background:var(--soft)}
    .nav-links a.active{background:var(--accent);color:#fff;}
    .nav-cta{
      background:#ffffff !important;
      color:#0a0a0a !important;
      margin-left:8px !important;
    }
    .nav-cta:hover{background:#f5f5f5 !important}

    .dropdown{position:relative}
    .dropdown > button{
      border:0;
      background:transparent;
      cursor:pointer;
      padding:8px 14px;
      border-radius:8px;
      font:inherit;
      font-weight:600;
      color:#e5e5e7;
      transition:all .15s;
    }
    .dropdown > button:hover{background:var(--soft)}
    .menu{
      position:absolute;
      top:100%;
      left:0;
      min-width:240px;
      background:#18181b;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      box-shadow:var(--shadow);
      display:none;
      margin-top:6px;
    }
    .menu a{
      display:block;
      padding:10px 12px;
      border-radius:8px;
      font-weight:600;
      font-size:13.5px;
      transition:all .15s;
      color:#e5e5e7;
    }
    .menu a:hover{background:#27272a}
    .menu a.active{background:var(--accent); color:#fff;}
    .dropdown:focus-within .menu{display:block}

    /* ===== Kepler背景（Section 1） ===== */
    #kepler-wrap {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      overflow: hidden;
      transition: opacity .6s ease;
    }

    #kepler-wrap.dimmed {
      opacity: 0.3;
      pointer-events: none;
    }

    #kepler-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      pointer-events: auto;
    }

    /* ===== Intro Modal ===== */
    #intro-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      transition: opacity .45s ease, visibility .45s ease;
    }

    #intro-modal.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .intro-card {
      background: rgba(10,10,10,.92);
      border: 1px solid rgba(249,115,22,.3);
      border-radius: 14px;
      padding: 48px 44px 44px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow), 0 0 60px rgba(249,115,22,.07);
      animation: introIn .5s cubic-bezier(.22,1,.36,1);
    }

    @keyframes introIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .intro-card .eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      font-weight: 900;
      margin-bottom: 18px;
    }

    .intro-card h1 {
      font-size: 22px;
      font-weight: 900;
      line-height: 1.4;
      margin-bottom: 24px;
      color: var(--ink);
    }

    .intro-card h1 em {
      font-style: normal;
      color: var(--accent);
    }

    .intro-stats {
      display: flex;
      justify-content: center;
      gap: 28px;
      margin-bottom: 26px;
    }

    .intro-stat {
      text-align: center;
    }

    .intro-stat .num {
      font-size: 26px;
      font-weight: 900;
      color: var(--ink);
      line-height: 1;
    }

    .intro-stat .num em {
      font-style: normal;
      color: var(--accent);
    }

    .intro-stat .lbl {
      font-size: 10.5px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-top: 6px;
      font-weight: 600;
    }

    .intro-card p {
      font-size: 13.5px;
      line-height: 1.7;
      color: var(--muted);
      margin-bottom: 28px;
    }

    .intro-btn {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      padding: 13px 38px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      letter-spacing: .3px;
      transition: background .2s, transform .15s;
    }

    .intro-btn:hover {
      background: #ea6d0e;
      transform: scale(1.03);
    }

    /* ===== Section Titles (Kepler + Mapbox separators) ===== */
    .section-divider{
      position: relative;
      z-index: 3;
      max-width: 1200px;
      margin: 0 auto 80px;
      padding: 0 24px;
      pointer-events: none;
    }
    .section-divider-inner{
      text-align: center;
    }
    .section-divider h2{
      font-size: 28px;
      font-weight: 900;
      line-height: 1.25;
      margin-bottom: 10px;
      color: var(--ink);
    }
    .section-divider h2 em{
      font-style: normal;
      color: var(--accent);
    }
    .section-divider p{
      font-size: 14px;
      line-height: 1.7;
      color: var(--muted);
      max-width: 820px;
      margin: 0 auto;
    }

    /* ===== Section 1: Opening Scrollytelling ===== */
    #opening-story {
      position: relative;
      z-index: 2;
      pointer-events: none;
      padding: 10vh 0 90vh;
    }

    .opening-step {
      pointer-events: auto;
      width: min(460px, 92vw);
      margin: 0 6vw 0 auto;
      opacity: .18;
      transition: opacity .25s ease;
    }

    .opening-step.active {
      opacity: 1;
    }

    .opening-card {
      background: rgba(10,10,10,.78);
      border: 1px solid rgba(249,115,22,.25);
      border-radius: var(--cardR);
      padding: 28px 28px 26px;
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 60px rgba(0,0,0,.7), 0 0 0 1px rgba(249,115,22,.1);
    }

    .opening-card .badge {
      display: inline-block;
      background: rgba(249,115,22,.12);
      border: 1px solid rgba(249,115,22,.22);
      color: var(--accent);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .6px;
      padding: 4px 12px;
      border-radius: 4px;
      margin-bottom: 14px;
    }

    .opening-card h3 {
      font-size: 18px;
      font-weight: 800;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .opening-card p {
      font-size: 13.5px;
      line-height: 1.7;
      color: var(--muted);
    }

    /* ===== Section 2: Mapbox Analysis ===== */
    #analysis-section {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      background: #f7fafc;
      padding-top: 120px;
    }

    .analysis-container {
      display: flex;
      height: 100vh;
    }

    /* 左侧控制面板 */
    .sidebar {
      width: 360px;
      background: #fff;
      border-right: 1px solid #e2e8f0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar-section {
      padding: 24px;
      border-bottom: 1px solid #e2e8f0;
    }

    .sidebar-section h2 {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #718096;
      margin-bottom: 16px;
    }

    .layer-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .layer-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .layer-item:hover {
      background: #f7fafc;
    }

    .layer-item.active {
      background: #ebf8ff;
      border-color: #4299e1;
    }

    .layer-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e0;
      border-radius: 4px;
      margin-right: 12px;
      position: relative;
      flex-shrink: 0;
    }

    .layer-item.active .layer-checkbox {
      background: #4299e1;
      border-color: #4299e1;
    }

    .layer-item.active .layer-checkbox::after {
      content: '✓';
      position: absolute;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .layer-info {
      flex: 1;
    }

    .layer-name {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 2px;
    }

    .layer-desc {
      font-size: 12px;
      color: #718096;
    }

    .layer-color {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .stat-card {
      background: #f7fafc;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: #2d3748;
      line-height: 1;
    }

    .stat-label {
      font-size: 11px;
      color: #718096;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .legend {
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .legend h3 {
      font-size: 12px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .legend-color {
      width: 20px;
      height: 16px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .legend-label {
      color: #4a5568;
      font-weight: 500;
    }

    #map {
      flex: 1;
      position: relative;
    }

    .mapboxgl-popup-content {
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      min-width: 200px;
    }

    .popup-title {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .popup-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .popup-label {
      color: #718096;
      font-weight: 500;
    }

    .popup-value {
      color: #2d3748;
      font-weight: 600;
    }

    /* ===== Section 3: NEW Flood System Sankey ===== */
    #sankey-section {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10vh 24px;
      background: var(--bg);
    }

    .sankey-container {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      width: 100%;
      background: rgba(10,10,10,.88);
      border: 1px solid var(--line);
      border-radius: var(--cardR);
      padding: 44px 40px 36px;
      box-shadow: var(--shadow);
    }

    .sankey-header {
      text-align: center;
      margin-bottom: 22px;
    }

    .sankey-header h2 {
      font-size: 28px;
      font-weight: 900;
      line-height: 1.25;
      margin-bottom: 10px;
      color: var(--ink);
    }

    .sankey-header h2 em {
      font-style: normal;
      color: #06b6d4;
    }

    .sankey-header p {
      font-size: 14px;
      line-height: 1.7;
      color: var(--muted);
      max-width: 820px;
      margin: 0 auto;
    }

    .sankey-col-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin: 18px 0 10px;
      padding: 0 90px;
    }

    .sankey-tools{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 14px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:#e5e5e7;
      font-weight:700;
      font-size:12.5px;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      transition: all .15s ease;
      user-select:none;
    }
    .chip:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .chip.active{ background: rgba(6,182,212,.14); border-color: rgba(6,182,212,.35); color:#d9fbff; }

    .sankey-legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .sankey-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11.5px;
      font-weight: 700;
      color: var(--muted);
    }

    .sankey-legend-item .sw {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      display: inline-block;
    }

    .sankey-insight {
      margin-top: 16px;
      padding: 18px 18px;
      background: rgba(6,182,212,.06);
      border: 1px solid rgba(6,182,212,.22);
      border-radius: var(--cardR);
    }

    .sankey-insight p {
      font-size: 13.5px;
      line-height: 1.75;
      color: #d4d4d8;
    }

    .sankey-insight b {
      color: #06b6d4;
      font-weight: 800;
    }

    #sankey-tooltip {
      position: absolute;
      background: rgba(10,10,10,.95);
      border: 1px solid #06b6d4;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      pointer-events: none;
      opacity: 0;
      box-shadow: 0 10px 30px rgba(0,0,0,.7);
      transition: opacity .2s ease;
      z-index: 10;
    }

    #sankey-tooltip.show { opacity: 1; }

    @keyframes pathGlow {
      0%, 100% { filter: drop-shadow(0 0 4px currentColor) brightness(1.15); }
      50% { filter: drop-shadow(0 0 9px currentColor) brightness(1.35); }
    }
  </style>
</head>

<body>

  <!-- ✅ Unified nav -->
  <div class="topnav">
    <div class="nav-inner">
      <a class="brand" href="index.html">HCMC Climate Risk Assessment</a>

      <div class="nav-links">
        <a href="story.html">Risk Assessment Story</a>

        <div class="dropdown" tabindex="0">
          <button type="button">Hazards ▾</button>
          <div class="menu">
            <a href="flood.html" class="active">Flood Risk</a>
            <a href="subsidence.html">Subsidence</a>
            <a href="temperature.html">Surface Temperature</a>
            <a href="exposure.html">Air Quality &amp; Exposure</a>
          </div>
        </div>

        <a href="dashboard.html">Risk Dashboard</a>
        <a href="crowdsourcing.html">Crowdsourcing</a>
        <a href="conclusion.html" class="nav-cta">Conclusion</a>
      </div>
    </div>
  </div>

  <!-- Intro Modal -->
  <div id="intro-modal">
    <div class="intro-card">
      <div class="eyebrow">HCMC · Flood Risk Analysis</div>
      <h1>Flood occurrence in<br>Ho Chi Minh City</h1>
      <div class="intro-stats">
        <div class="intro-stat">
          <div class="num"><em>40</em></div>
          <div class="lbl">Years · 1984–2024</div>
        </div>
        <div class="intro-stat">
          <div class="num"><em>80+</em></div>
          <div class="lbl">Max occurrence</div>
        </div>
        <div class="intro-stat">
          <div class="num"><em>1.6</em><span style="font-size:14px;color:var(--muted)">m</span></div>
          <div class="lbl">Mean elev.</div>
        </div>
      </div>
      <p>Pixel-level flood records across 24 districts — spatial distribution, frequency analysis, and proximity to water bodies.</p>
      <button class="intro-btn" onclick="dismissIntro()">Explore →</button>
    </div>
  </div>

  <!-- Kepler背景 -->
  <div id="kepler-wrap">
    <iframe id="kepler-frame" src="kepler.gl.html"></iframe>
  </div>

  <!-- ✅ Section 1 Title -->
  <div id="opening-story">
    <div class="section-divider">
      <div class="section-divider-inner">
        <h2>Patterns · <em>flood occurrences (1984–2024)</em></h2>
        <p>Scroll to read the story — the background map stays fixed to highlight where events repeat.</p>
      </div>
    </div>

    <!-- Opening steps -->
    <div class="opening-step" data-step="0">
      <div class="opening-card">
        <div class="badge">1984–2024</div>
        <h3>Four decades of documented urban flooding</h3>
        <p>Every point on the map represents a recorded flood event. The spatial pattern reveals the city's hydro-geographical vulnerability.</p>
      </div>
    </div>

    <div class="opening-step" data-step="1">
      <div class="opening-card">
        <div class="badge">SUBSIDENCE + SEA LEVEL RISE</div>
        <h3>Ground is sinking, water is rising</h3>
        <p>The mean elevation sits at 1.6 meters. Some central districts have sunk 2–3 cm per year. Combine that with 3.3 mm annual sea-level rise, and the window for effective intervention shrinks rapidly.</p>
      </div>
    </div>

    <div class="opening-step" data-step="2">
      <div class="opening-card">
        <div class="badge">SPATIAL ANALYSIS</div>
        <h3>Understanding distribution patterns</h3>
        <p>Geographic analysis reveals where flood frequency clusters most intensely — and how proximity to water bodies correlates with risk. Scroll down to explore the data layers.</p>
      </div>
    </div>
  </div>

  <!-- ✅ Section 2 Title + Content -->
  <div id="analysis-section">
    <div class="section-divider">
      <div class="section-divider-inner">
        <h2>Evidence · <em>frequency bands & distance-to-water</em></h2>
        <p>Toggle layers to compare hotspots, then hover to read counts and water-distance categories.</p>
      </div>
    </div>

    <div class="analysis-container">

      <!-- Sidebar -->
      <div class="sidebar">

        <div class="sidebar-section">
          <h2>MAP BOUNDARIES</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">24</div>
              <div class="stat-label">Districts</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">40 yrs</div>
              <div class="stat-label">1984–2024</div>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h2>INDICATOR NAVIGATION</h2>

          <div class="layer-list">
            <div class="layer-item active" data-layer="all">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">All Flood Frequency</div>
                <div class="layer-desc">Complete occurrence map</div>
              </div>
            </div>

            <div class="layer-item" data-layer="low">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">Low Frequency</div>
                <div class="layer-desc">1–20 occurrences</div>
              </div>
              <div class="layer-color" style="background:#dce9f5"></div>
            </div>

            <div class="layer-item" data-layer="medium">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">Medium Frequency</div>
                <div class="layer-desc">21–40 occurrences</div>
              </div>
              <div class="layer-color" style="background:#a3c9e8"></div>
            </div>

            <div class="layer-item" data-layer="high">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">High Frequency</div>
                <div class="layer-desc">41–60 occurrences</div>
              </div>
              <div class="layer-color" style="background:#5fa3d2"></div>
            </div>

            <div class="layer-item" data-layer="very_high">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">Very High Frequency</div>
                <div class="layer-desc">61+ occurrences</div>
              </div>
              <div class="layer-color" style="background:#1a3a5c"></div>
            </div>

            <div class="layer-item" data-layer="water-dist">
              <div class="layer-checkbox"></div>
              <div class="layer-info">
                <div class="layer-name">Distance to Water</div>
                <div class="layer-desc">Proximity analysis</div>
              </div>
            </div>
          </div>

          <div class="legend" id="legend-container">
            <h3>Flood Frequency</h3>
            <div class="legend-item">
              <div class="legend-color" style="background:#dce9f5"></div>
              <div class="legend-label">1–20 events</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#a3c9e8"></div>
              <div class="legend-label">21–40 events</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#5fa3d2"></div>
              <div class="legend-label">41–60 events</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#1a3a5c"></div>
              <div class="legend-label">61+ events</div>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h2>GEOGRAPHIC CONTEXT</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">1.6m</div>
              <div class="stat-label">Mean Elevation</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">96</div>
              <div class="stat-label">Grid Cells</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Map -->
      <div id="map"></div>

    </div>
  </div>

  <!-- ✅ Section 3: NEW System Sankey (Flood) -->
  <div id="sankey-section">
    <div class="sankey-container">
      <div class="sankey-header">
        <h2>Flood system · <em>drivers → processes → impacts</em></h2>
        <p>
          Flood risk in HCMC is not only caused by heavy rains. It is a compounding system: sinking ground reduces drainage,
          tides push water inland, and dense impervious urban form accelerates runoff — turning routine events
          into repeated disruptions.
        </p>
      </div>

      <div class="sankey-col-labels">
        <span>Drivers</span>
        <span>Flood Processes</span>
        <span>Impacts</span>
      </div>

      <div class="sankey-tools" aria-label="Sankey filters">
        <button class="chip active" data-filter="all">All flows</button>
        <button class="chip" data-filter="compound">Compound events (rain + tide)</button>
        <button class="chip" data-filter="subsidence">Subsidence amplification</button>
        <button class="chip" data-filter="urban">Urban runoff</button>
      </div>

      <svg id="sankey-svg" viewBox="0 0 1100 460"></svg>

      <div class="sankey-legend">
        <div class="sankey-legend-item"><span class="sw" style="background:#64748b"></span>Drivers</div>
        <div class="sankey-legend-item"><span class="sw" style="background:#06b6d4"></span>Flood processes</div>
        <div class="sankey-legend-item"><span class="sw" style="background:#f97316"></span>Impacts</div>
      </div>

      <div class="sankey-insight">
        <p>
          <b>Why hotspots persist:</b> repeated flooding concentrates where <b>low elevation</b>, <b>canal proximity</b>,
          and <b>drainage limits</b> overlap — especially under <b>rain–tide concurrence</b> and <b>subsidence-driven
          loss of capacity</b>.
        </p>
      </div>
    </div>
  </div>

  <div id="sankey-tooltip"></div>

  <script>
    // ===== Modal =====
    function dismissIntro() {
      document.getElementById('intro-modal').classList.add('hidden');
    }
    setTimeout(dismissIntro, 15000);

    // ===== Kepler dimming =====
    const keplerWrap = document.getElementById('kepler-wrap');
    let currentSection = 'opening';

    const sectObs = new IntersectionObserver(ents => {
      ents.forEach(e => {
        if (!e.isIntersecting) return;
        const id = e.target.id;

        if (id === 'opening-story') {
          currentSection = 'opening';
          keplerWrap.classList.remove('dimmed');
        } else if (id === 'analysis-section' || id === 'sankey-section') {
          currentSection = id;
          keplerWrap.classList.add('dimmed');
        }
      });
    }, { threshold: 0.3 });

    ['opening-story', 'analysis-section', 'sankey-section'].forEach(id => {
      const el = document.getElementById(id);
      if (el) sectObs.observe(el);
    });

    // ===== Opening scrollytelling =====
    const openingScroller = scrollama();
    openingScroller.setup({ step: '.opening-step', offset: 0.5 }).onStepEnter(r => {
      document.querySelectorAll('.opening-step').forEach(s => s.classList.remove('active'));
      r.element.classList.add('active');
    });

    // ===== Mapbox =====
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGV4aW55aTA1MjEiLCJhIjoiY203dTdydmxmMDFndTJycXN3cHkybHY5cCJ9.vZZQOhyDe4mJUqD1YnuySQ';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [106.6917, 10.7769],
      zoom: 11
    });

    const layers = {
      low: { file: 'output/flood_low.geojson', color: '#dce9f5' },
      medium: { file: 'output/flood_medium.geojson', color: '#a3c9e8' },
      high: { file: 'output/flood_high.geojson', color: '#5fa3d2' },
      very_high: { file: 'output/flood_very_high.geojson', color: '#1a3a5c' },
      'water-dist': {
        file: 'output/flood_analysis_grid.geojson',
        type: 'grid',
        colorMap: {
          '0-500m': '#b71c1c',
          '500-1000m': '#f57c00',
          '1-5km': '#fdd835',
          '>5km': '#7cb342'
        }
      }
    };

    // ✅ global popup
    let currentPopup = null;

    map.on('load', () => {
      Object.entries(layers).forEach(([key, config]) => {
        map.addSource(key, {
          type: 'geojson',
          data: config.file
        });

        if (config.type === 'grid') {
          map.addLayer({
            id: key,
            type: 'fill',
            source: key,
            paint: {
              'fill-color': [
                'match',
                ['get', 'dist_category'],
                '0-500m', config.colorMap['0-500m'],
                '500-1000m', config.colorMap['500-1000m'],
                '1-5km', config.colorMap['1-5km'],
                '>5km', config.colorMap['>5km'],
                '#cccccc'
              ],
              'fill-opacity': 0.6
            },
            layout: { 'visibility': 'none' }
          });
        } else {
          map.addLayer({
            id: key,
            type: 'fill',
            source: key,
            paint: {
              'fill-color': config.color,
              'fill-opacity': 0.7
            },
            layout: { 'visibility': 'visible' }
          });
        }

        // Hover popup
        map.on('mousemove', key, (e) => {
          if (e.features.length > 0) {
            if (currentPopup) currentPopup.remove();

            const props = e.features[0].properties;
            let html = '<div class="popup-title">Flood Data</div>';

            if (props.flood_count) {
              html += `<div class="popup-row">
                <span class="popup-label">Occurrences:</span>
                <span class="popup-value">${Math.round(props.flood_count)}</span>
              </div>`;
            }

            if (props.dist_category) {
              html += `<div class="popup-row">
                <span class="popup-label">Water Distance:</span>
                <span class="popup-value">${props.dist_category}</span>
              </div>`;
            }

            currentPopup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
            })
              .setLngLat(e.lngLat)
              .setHTML(html)
              .addTo(map);
          }
        });

        map.on('mouseleave', key, () => {
          if (currentPopup) {
            currentPopup.remove();
            currentPopup = null;
          }
        });
      });
    });

    // ===== Layer switching =====
    document.querySelectorAll('.layer-item').forEach(item => {
      item.addEventListener('click', () => {
        const layer = item.dataset.layer;

        document.querySelectorAll('.layer-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        if (layer === 'all') {
          ['low', 'medium', 'high', 'very_high'].forEach(k => {
            map.setLayoutProperty(k, 'visibility', 'visible');
          });
          map.setLayoutProperty('water-dist', 'visibility', 'none');
          updateLegend('flood');
        } else if (layer === 'water-dist') {
          ['low', 'medium', 'high', 'very_high'].forEach(k => {
            map.setLayoutProperty(k, 'visibility', 'none');
          });
          map.setLayoutProperty('water-dist', 'visibility', 'visible');
          updateLegend('water-dist');
        } else {
          ['low', 'medium', 'high', 'very_high'].forEach(k => {
            map.setLayoutProperty(k, 'visibility', k === layer ? 'visible' : 'none');
          });
          map.setLayoutProperty('water-dist', 'visibility', 'none');
          updateLegend('flood');
        }
      });
    });

    function updateLegend(type) {
      const legendContainer = document.getElementById('legend-container');

      if (type === 'water-dist') {
        legendContainer.innerHTML = `
          <h3>Distance to Water Bodies</h3>
          <div class="legend-item">
            <div class="legend-color" style="background:#b71c1c"></div>
            <div class="legend-label">0–500m</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#f57c00"></div>
            <div class="legend-label">500–1000m</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#fdd835"></div>
            <div class="legend-label">1–5km</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#7cb342"></div>
            <div class="legend-label">&gt;5km</div>
          </div>
        `;
      } else {
        legendContainer.innerHTML = `
          <h3>Flood Frequency</h3>
          <div class="legend-item">
            <div class="legend-color" style="background:#dce9f5"></div>
            <div class="legend-label">1–20 events</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#a3c9e8"></div>
            <div class="legend-label">21–40 events</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#5fa3d2"></div>
            <div class="legend-label">41–60 events</div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background:#1a3a5c"></div>
            <div class="legend-label">61+ events</div>
          </div>
        `;
      }
    }

    // ===== NEW: Interactive Flood System Sankey (lightweight custom) =====
    (function(){
      const svg = d3.select('#sankey-svg');
      const tooltip = d3.select('#sankey-tooltip');

      const COLORS = {
        driver: '#64748b',
        process: '#06b6d4',
        impact: '#f97316'
      };

      // Nodes: Drivers (0), Processes (1), Impacts (2)
      const nodes = [
        // Drivers (layer 0)
        {id:0, name:'Low\nElevation\n& Deltaic\nSetting', layer:0, value:22, color:COLORS.driver, tag:['compound','subsidence']},
        {id:1, name:'Sea-Level\nRise &\nHigh Tides', layer:0, value:20, color:COLORS.driver, tag:['compound']},
        {id:2, name:'Intensifying\nMonsoon\nRainfall', layer:0, value:20, color:COLORS.driver, tag:['compound']},
        {id:3, name:'Groundwater\nExtraction\n→ Subsidence', layer:0, value:18, color:COLORS.driver, tag:['subsidence']},
        {id:4, name:'Rapid\nUrbanization\n(Impervious)', layer:0, value:20, color:COLORS.driver, tag:['urban']},

        // Processes (layer 1)
        {id:5, name:'Reduced\nDrainage\nCapacity', layer:1, value:26, color:COLORS.process, tag:['subsidence']},
        {id:6, name:'Compound\nRain–Tide\nEvents', layer:1, value:28, color:COLORS.process, tag:['compound']},
        {id:7, name:'Canal/\nOutfall\nBackflow', layer:1, value:20, color:COLORS.process, tag:['compound']},
        {id:8, name:'Fast\nSurface\nRunoff', layer:1, value:26, color:COLORS.process, tag:['urban']},

        // Impacts (layer 2)
        {id:9,  name:'Road\nInundation\n& Mobility\nDisruption', layer:2, value:30, color:COLORS.impact, tag:['compound','urban']},
        {id:10, name:'Property\nDamage &\nAsset Loss', layer:2, value:22, color:COLORS.impact, tag:['compound','subsidence']},
        {id:11, name:'Service\nInterruptions\n(Drainage,\nPower)', layer:2, value:18, color:COLORS.impact, tag:['subsidence','urban']},
        {id:12, name:'Public\nHealth\nExposure', layer:2, value:16, color:COLORS.impact, tag:['compound']},
        {id:13, name:'Economic\nDisruption\nand Loss', layer:2, value:14, color:COLORS.impact, tag:['compound','urban']}
      ];

      // Links with category tags for quick filtering
      const links = [
        // Drivers -> Processes
        {s:0, t:5, v:10, tag:'subsidence'},
        {s:0, t:6, v:8,  tag:'compound'},
        {s:0, t:7, v:4,  tag:'compound'},

        {s:1, t:6, v:12, tag:'compound'},
        {s:1, t:7, v:8,  tag:'compound'},

        {s:2, t:6, v:10, tag:'compound'},
        {s:2, t:8, v:10, tag:'urban'},

        {s:3, t:5, v:12, tag:'subsidence'},
        {s:3, t:7, v:6,  tag:'subsidence'},

        {s:4, t:8, v:16, tag:'urban'},
        {s:4, t:5, v:4,  tag:'urban'},

        // Processes -> Impacts
        {s:5, t:9,  v:8, tag:'subsidence'},
        {s:5, t:10, v:8, tag:'subsidence'},
        {s:5, t:11, v:6, tag:'subsidence'},
        {s:5, t:13, v:4, tag:'subsidence'},

        {s:6, t:9,  v:12, tag:'compound'},
        {s:6, t:10, v:8,  tag:'compound'},
        {s:6, t:12, v:4,  tag:'compound'},
        {s:6, t:13, v:4,  tag:'compound'},

        {s:7, t:9,  v:6, tag:'compound'},
        {s:7, t:10, v:6, tag:'compound'},
        {s:7, t:12, v:4, tag:'compound'},
        {s:7, t:11, v:4, tag:'subsidence'},

        {s:8, t:9,  v:10, tag:'urban'},
        {s:8, t:11, v:8,  tag:'urban'},
        {s:8, t:13, v:8,  tag:'urban'}
      ];

      // ---- Layout (3 columns) ----
      const W = 1100, H = 460, nodeW = 28, pad = 16;
      const mar = {t:24, b:20, l:96, r:96};
      const availH = H - mar.t - mar.b;
      const colX = [mar.l, W/2 - nodeW/2, W - mar.r - nodeW];

      const layers = [[],[],[]];
      nodes.forEach(n => layers[n.layer].push(n));

      layers.forEach(ln => {
        const tot = ln.reduce((a,n)=>a+n.value,0);
        const sc  = (availH - pad*(ln.length-1)) / tot;
        let yy = mar.t;
        ln.forEach(n => {
          n.x = colX[n.layer];
          n.y = yy;
          n.h = n.value * sc;
          n._sOff = 0;
          n._tOff = 0;
          yy += n.h + pad;
        });
      });

      // ribbons: store path coords
      function calcRibbon(set){
        set.forEach(l => {
          const src = nodes[l.s], tgt = nodes[l.t];
          const sh = (l.v / src.value) * src.h;
          const th = (l.v / tgt.value) * tgt.h;
          l._p = {
            sx: src.x + nodeW,
            sy0: src.y + src._sOff,
            sy1: src.y + src._sOff + sh,
            tx: tgt.x,
            ty0: tgt.y + tgt._tOff,
            ty1: tgt.y + tgt._tOff + th
          };
          src._sOff += sh;
          tgt._tOff += th;
        });
      }

      // reset offsets then compute in two phases (0->1 and 1->2)
      nodes.forEach(n=>{ n._sOff=0; n._tOff=0; });
      calcRibbon(links.filter(l => nodes[l.s].layer===0).sort((a,b)=>a.s-b.s||a.t-b.t));
      calcRibbon(links.filter(l => nodes[l.s].layer===1).sort((a,b)=>a.s-b.s||a.t-b.t));

      function ribbonD(l){
        const {sx,sy0,sy1,tx,ty0,ty1} = l._p;
        const mx = (sx + tx) / 2;
        return `M${sx},${sy0} C${mx},${sy0} ${mx},${ty0} ${tx},${ty0} L${tx},${ty1} C${mx},${ty1} ${mx},${sy1} ${sx},${sy1} Z`;
      }

      svg.attr('viewBox', `0 0 ${W} ${H}`);
      svg.selectAll('*').remove();

      const gLinks = svg.append('g');

      const linkSel = gLinks.selectAll('path')
        .data(links)
        .enter()
        .append('path')
        .attr('d', ribbonD)
        .attr('fill', d => nodes[d.s].color)
        .attr('opacity', 0.22)
        .attr('stroke', 'none')
        .style('transition','all .25s ease')
        .on('mouseover', function(e, d){
          d3.select(this)
            .attr('opacity', 0.78)
            .style('animation','pathGlow 1.4s infinite');
          const s = nodes[d.s].name.replaceAll('\n',' ');
          const t = nodes[d.t].name.replaceAll('\n',' ');
          tooltip.html(`<b>${s}</b> → <b>${t}</b><br>${d.v} weight`)
            .style('left', (e.pageX + 14) + 'px')
            .style('top', (e.pageY - 12) + 'px')
            .classed('show', true);
        })
        .on('mouseout', function(){
          d3.select(this).attr('opacity', 0.22).style('animation','none');
          tooltip.classed('show', false);
        });

      const gNodes = svg.append('g').selectAll('g')
        .data(nodes)
        .enter()
        .append('g');

      gNodes.append('rect')
        .attr('x', d=>d.x)
        .attr('y', d=>d.y)
        .attr('width', nodeW)
        .attr('height', d=>d.h)
        .attr('fill', d=>d.color)
        .attr('rx', 4)
        .style('filter','drop-shadow(0 2px 4px rgba(0,0,0,0.35))')
        .style('transition','all .25s ease')
        .on('mouseover', function(e, d){
          d3.select(this)
            .style('filter', `drop-shadow(0 6px 16px ${d.color}) brightness(1.2)`)
            .attr('width', nodeW+4)
            .attr('x', d.x-2);

          tooltip.html(`<b>${d.name.replaceAll('\n',' ')}</b><br>${d.value} total`)
            .style('left', (e.pageX + 14) + 'px')
            .style('top', (e.pageY - 12) + 'px')
            .classed('show', true);

          // softly highlight connected links
          linkSel.attr('opacity', l => (l.s===d.id || l.t===d.id) ? 0.72 : 0.10);
        })
        .on('mouseout', function(e, d){
          d3.select(this)
            .style('filter','drop-shadow(0 2px 4px rgba(0,0,0,0.35))')
            .attr('width', nodeW)
            .attr('x', d.x);

          tooltip.classed('show', false);
          linkSel.attr('opacity', 0.22);
        });

      // Labels
      gNodes.append('text')
        .attr('x', d => d.layer===0 ? d.x-10 : d.x+nodeW+10)
        .attr('y', d => d.y + d.h/2 - 6)
        .attr('text-anchor', d => d.layer===0 ? 'end' : 'start')
        .attr('fill', '#e5e5e7')
        .attr('font-size', '11px')
        .attr('font-family', 'Inter')
        .attr('font-weight', '800')
        .each(function(d){
          const parts = d.name.split('\n');
          const sel = d3.select(this);
          parts.forEach((t,i)=>{
            sel.append('tspan')
              .attr('x', this.getAttribute('x'))
              .attr('dy', i ? '1.15em' : '0')
              .text(t);
          });
        });

      gNodes.append('text')
        .attr('x', d => d.layer===0 ? d.x-10 : d.x+nodeW+10)
        .attr('y', d => d.y + d.h/2 + 18)
        .attr('text-anchor', d => d.layer===0 ? 'end' : 'start')
        .attr('fill', '#a1a1aa')
        .attr('font-size', '10px')
        .attr('font-family', 'Inter')
        .attr('font-weight', '700')
        .text(d => d.value);

      // ---- Filter chips ----
      const chips = document.querySelectorAll('.chip');
      let currentFilter = 'all';

      function applyFilter(f){
        currentFilter = f;
        chips.forEach(c => c.classList.toggle('active', c.dataset.filter===f));

        linkSel.each(function(d){
          const show = (f==='all') ? true : (d.tag===f);
          d3.select(this)
            .attr('opacity', show ? 0.30 : 0.06)
            .style('animation', 'none');
        });
      }

      chips.forEach(c => {
        c.addEventListener('click', () => applyFilter(c.dataset.filter));
      });

      // start at all
      applyFilter('all');
    })();
  </script>

</body>
</html>